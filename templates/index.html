<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{{ app_name }}</title>

<link rel="stylesheet"
 href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

<style>
:root{
  --navy:#0b2545;
  --green:#1f6f54;
  --bg:#f2f4f6;
  --gray:#8a8f98;
  --white:#ffffff;
}

body{
  margin:0;
  padding:28px;
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  color:var(--navy);
}

header{
  max-width:1200px;
  margin:auto;
  display:flex;
  align-items:center;
  gap:14px;
}

.logo{
  width:42px;height:42px;
  border-radius:50%;
  background:var(--green);
  color:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}

h1{margin:0;font-size:26px}

.context{
  margin:8px auto 18px auto;
  max-width:1200px;
  color:var(--gray);
}

.filters{
  max-width:1200px;
  margin:auto;
  background:var(--white);
  padding:14px;
  border-radius:12px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}

select{
  padding:8px;
  border-radius:8px;
  border:1px solid #dcdfe3;
}

.actions{
  max-width:1200px;
  margin:12px auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:14px;
  color:var(--gray);
}

button{
  background:var(--green);
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}

.empty{
  text-align:center;
  padding:40px;
  color:var(--gray);
}
</style>
</head>

<body>

<header>
  <div class="logo">EV</div>
  <h1>{{ app_name }}</h1>
</header>

<div class="context">
  EV category: <strong>{{ selected_ev }}</strong> Â· GO term: {{ go_term }}
</div>

<div class="filters">
  <select id="ev">
    {% for ev in ev_options %}
      <option value="{{ ev }}" {% if ev==selected_ev %}selected{% endif %}>{{ ev }}</option>
    {% endfor %}
  </select>
  <select id="species"><option value="">All species</option>
    {% for s in species_options %}<option>{{ s }}</option>{% endfor %}
  </select>
  <select id="isolation"><option value="">All isolation</option>
    {% for i in isolation_options %}<option>{{ i }}</option>{% endfor %}
  </select>
  <select id="year"><option value="">All years</option>
    {% for y in year_options %}<option>{{ y }}</option>{% endfor %}
  </select>
</div>

<div class="actions">
  <span id="resultInfo"></span>
  <button id="exportBtn">Export CSV (current query)</button>
</div>

<table id="evTable" class="display" style="width:100%;max-width:1200px;margin:auto">
  <thead>
    <tr>
      <th>Vesicle type</th>
      <th>Species</th>
      <th>Isolation</th>
      <th>Year</th>
    </tr>
  </thead>
</table>

<div id="empty" class="empty" style="display:none">
  No records match your current filters.
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script>
const table = $('#evTable').DataTable({
  serverSide:true,
  processing:true,
  ajax:{
    url:"/api/table",
    data:function(d){
      d.ev=$('#ev').val();
      d.species=$('#species').val();
      d.isolation=$('#isolation').val();
      d.year=$('#year').val();
    }
  },
  drawCallback:function(settings){
    const info=settings.json.recordsFiltered;
    $('#resultInfo').text(info+" records found");
    $('#empty').toggle(info===0);
  }
});

$('select').on('change',()=>table.ajax.reload());

$('#exportBtn').on('click',()=>{
  const params=$.param({
    ev:$('#ev').val(),
    species:$('#species').val(),
    isolation:$('#isolation').val(),
    year:$('#year').val()
  });
  window.location="/api/export?"+params;
});
</script>

</body>
</html>